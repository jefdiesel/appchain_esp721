<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ChainHost — Token Launcher</title>
<link rel="icon" href="https://chainhost.online/favicon.png">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--card:#12121a;--border:#1e1e2e;--text:#e0e0e0;--dim:#666;--accent:#c3ff00;--green:#00b894;--red:#d63031;--curve:#c3ff00}
body{font-family:'SF Mono',Monaco,Consolas,monospace;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:0 1rem 2rem}
.nav{width:100%;max-width:480px;display:flex;align-items:center;justify-content:space-between;padding:1rem 0;margin-bottom:1.5rem;border-bottom:1px solid var(--border)}
.nav a{text-decoration:none;color:var(--text)}.nav-logo{font-size:1.1rem;font-weight:700;display:flex;align-items:center;gap:.5rem}
.nav-logo img{width:18px;height:18px}.nav-logo .ch{color:var(--accent)}
.nav-links{display:flex;gap:.75rem;font-size:.75rem}
.nav-links a{color:var(--dim);transition:.15s}.nav-links a:hover{color:var(--accent)}
.nav-links .cta{background:var(--accent);color:#000;padding:.35rem .7rem;border-radius:6px;font-weight:600}.nav-links .cta:hover{opacity:.85}
.c{max-width:480px;width:100%}
h1{font-size:1.8rem;text-align:center;margin-bottom:.25rem}
.sub{text-align:center;color:var(--dim);font-size:.8rem;margin-bottom:2rem}
.cd{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.25rem;margin-bottom:1rem}
.cd h2{font-size:.85rem;color:var(--dim);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.75rem}
.sr{display:flex;justify-content:space-between;padding:.35rem 0;font-size:.85rem}
.sl{color:var(--dim)}.sv{font-weight:600}
.pb{font-size:1.6rem;font-weight:700;text-align:center;padding:.5rem 0}
.pu{font-size:.8rem;color:var(--dim);font-weight:400}
canvas{width:100%;height:160px;display:block;margin:.5rem 0;border-radius:8px}
.tabs{display:flex;margin-bottom:1rem;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.tab{flex:1;padding:.6rem;text-align:center;cursor:pointer;font-size:.85rem;font-weight:600;background:var(--card);border:none;color:var(--dim);font-family:inherit;transition:.15s}
.tab.a{background:var(--accent);color:#000}.tab:hover:not(.a){background:#1a1a2e}
.ig{margin-bottom:1rem}
.ig label{display:block;font-size:.75rem;color:var(--dim);margin-bottom:.4rem;text-transform:uppercase;letter-spacing:.04em}
.ir{display:flex;gap:.5rem;align-items:center}
.ir input{flex:1;background:#0d0d15;border:1px solid var(--border);border-radius:8px;padding:.65rem .85rem;color:var(--text);font-size:1rem;font-family:inherit;outline:none}
.ir input:focus{border-color:var(--accent)}
.mx{background:var(--border);border:none;border-radius:6px;padding:.45rem .75rem;color:var(--text);cursor:pointer;font-size:.75rem;font-family:inherit}
.mx:hover{background:var(--accent);color:#000}
.cp{background:#0d0d15;border-radius:8px;padding:.75rem;margin-bottom:1rem;font-size:.8rem}
.cp .rw{display:flex;justify-content:space-between;padding:.2rem 0}
.cp .tt{border-top:1px solid var(--border);margin-top:.3rem;padding-top:.4rem;font-weight:700}
.bt{width:100%;padding:.75rem;border:none;border-radius:8px;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;transition:.15s}
.bt:hover{opacity:.85;transform:translateY(-1px)}.bt:disabled{opacity:.4;cursor:not-allowed;transform:none}
.bb{background:var(--green);color:#000}.bs{background:var(--red);color:#fff}
.cn{background:var(--accent);color:#000;margin-bottom:1rem}
.wi{text-align:center;font-size:.8rem;color:var(--dim);margin-bottom:1rem}
.wi .ad{color:var(--accent)}.wi .bl{color:var(--green)}
.pg{height:6px;background:#1a1a2e;border-radius:3px;overflow:hidden;margin:.5rem 0}
.pf{height:100%;background:linear-gradient(90deg,var(--accent),var(--curve));border-radius:3px;transition:width .3s}
.ts{text-align:center;padding:.75rem;border-radius:8px;font-size:.85rem;margin-top:.75rem;display:none}
.ts.pe{display:block;background:#1a1a2e;color:var(--dim)}
.ts.ok{display:block;background:#00b89422;color:var(--green)}
.ts.er{display:block;background:#d6303122;color:var(--red)}
.migrated-banner{background:var(--accent);color:#000;text-align:center;padding:1rem;border-radius:12px;margin-bottom:1rem;font-weight:700}
.migrated-banner a{color:#000;text-decoration:underline}
.ft{text-align:center;color:var(--dim);font-size:.7rem;margin-top:2rem}.ft a{color:var(--accent);text-decoration:none}
.token-title{font-size:1.4rem;font-weight:700;color:var(--accent);text-align:center;margin-bottom:.5rem}
.name-list{list-style:none;display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem}
.name-list li{background:#0d0d15;border:1px solid var(--border);border-radius:8px;padding:.5rem .85rem;cursor:pointer;font-size:.85rem;transition:.15s}
.name-list li:hover{border-color:var(--accent);color:var(--accent)}
.name-list li.sel{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700}
.name-list li.used{opacity:.3;cursor:not-allowed;text-decoration:line-through}
.names-loading{color:var(--dim);font-size:.8rem;text-align:center;padding:1rem}
.no-names{color:var(--dim);font-size:.85rem;text-align:center;padding:1rem}
.info-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.25rem;margin-bottom:1rem;font-size:.8rem;color:var(--dim);line-height:1.7}
.info-card h2{font-size:.85rem;color:var(--dim);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.75rem}
.info-card ul{list-style:none;padding:0}.info-card li{padding:.2rem 0}.info-card li::before{content:"·";color:var(--accent);margin-right:.5rem;font-weight:700}
.info-card b{color:var(--text)}.info-card a{color:var(--accent);text-decoration:none}
.reg-link{display:block;text-align:center;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem;color:var(--accent);text-decoration:none;font-size:.85rem;font-weight:600;transition:.15s}
.reg-link:hover{border-color:var(--accent);background:#1a1a2e}
</style>
</head>
<body>
<div class="c">
<nav class="nav"><a href="https://chainhost.online" class="nav-logo"><img src="https://chainhost.online/favicon.png" alt="">Chain<span class="ch">Host</span></a><div class="nav-links"><a href="https://chainhost.online/register">Register</a><a href="https://chainhost.online/marketplace">Market</a><a href="https://chainhost.online/upload" class="cta">Upload</a></div></nav>
<h1 style="color:var(--accent)">Token Launcher</h1>
<p class="sub">Launch an Ethereum bonding curve token on a gentler polynomial curve</p>
<button class="bt cn" id="cb" onclick="cw()">Connect Wallet</button>
<div class="wi" id="wf" style="display:none"><span class="ad" id="wa"></span></div>

<div class="info-card">
<h2>How it works</h2>
<ul>
<li>Token names are tied to <b>ethscription names</b> you own (SHA256 secured)</li>
<li>Tokens trade on a <b>polynomial bonding curve</b> (x<sup>1.5</sup>) — gentler than exponential</li>
<li>At <b>69% supply sold</b>, auto-migrates to <b>Uniswap V2</b> with LP burned forever</li>
<li><b>0.69% fee</b> on sells during bonding phase</li>
<li>Creator receives <b>0.069 ETH</b> at migration</li>
<li>1% of supply minted to platform at migration (half sold, half kept)</li>
<li>Your token lives at <b>name.chainhost.online</b> — instant trade page</li>
</ul>
</div>

<a href="https://chainhost.online/register" class="reg-link">Don't have a name? Register one on Ethereum</a>

<!-- CREATE TOKEN PANEL -->
<div id="create-panel" class="cd">
<h2>Launch Token</h2>
<p class="names-loading" id="names-loading">Connect wallet to see your names</p>
<ul class="name-list" id="name-list" style="display:none"></ul>
<p class="no-names" id="no-names" style="display:none">No ethscription names found. <a href="https://chainhost.online/register" style="color:var(--accent)">Register a name</a> first.</p>
<div id="create-options" style="display:none">
<div class="ig"><label>Max Supply</label>
<div class="ir"><input type="number" id="supply-input" placeholder="694200000" value="694200000" oninput="calcPreview()"></div></div>
<div class="ig"><label>Base Price (gwei)</label>
<div class="ir"><input type="number" id="price-input" placeholder="100" value="100" oninput="calcPreview()"></div></div>
<div class="cp" id="launch-preview">
<div class="rw"><span>Price at migration (69%)</span><span id="pv-migprice">—</span></div>
<div class="rw"><span>Market cap at migration</span><span id="pv-migmc">—</span></div>
<div class="rw"><span>Liquidity at migration</span><span id="pv-raised">—</span></div>
<div class="rw" style="border-top:1px solid var(--border);margin-top:.3rem;padding-top:.4rem"><span>Price at full supply</span><span id="pv-fullprice">—</span></div>
<div class="rw"><span>Fully diluted MC</span><span id="pv-fdmc">—</span></div>
</div>
<button class="bt cn" id="create-btn" onclick="createToken()">Launch $<span id="selected-name-btn"></span></button>
</div>
<div class="ts" id="create-status"></div>
</div>

<!-- TRADE PANEL (hidden until token loaded) -->
<div id="token-panel" style="display:none">
<div class="token-title">$<span id="token-name"></span></div>
<div class="wi" id="token-bal-wrap" style="display:none"><span class="bl" id="wb">0</span> tokens</div>
<div id="migrated-msg" class="migrated-banner" style="display:none">
Migrated! <a id="uni-link" href="#" target="_blank">Trade on Uniswap</a>
</div>
<div class="cd"><h2>Price</h2>
<div class="pb" id="sp">0.000000 <span class="pu">ETH</span></div>
<div class="sr"><span class="sl">Supply</span><span class="sv"><span id="cs">0</span> / <span id="ms">0</span></span></div>
<div class="pg"><div class="pf" id="sb" style="width:0%"></div></div>
<div class="sr"><span class="sl">Reserve</span><span class="sv" id="rv">0 ETH</span></div>
<div class="sr"><span class="sl">Curve</span><span class="sv">x<sup>1.5</sup></span></div></div>
<div class="cd"><h2>Price Curve</h2><canvas id="cc" height="160"></canvas></div>
<div class="cd" id="trade-card">
<div class="tabs"><button class="tab a" id="tb" onclick="sm('b')">Buy</button><button class="tab" id="ts2" onclick="sm('s')">Sell</button></div>
<div class="ig"><label id="amt-label">Amount</label>
<div class="ir"><input type="number" id="am" placeholder="0" min="0" oninput="up()"><button class="mx" onclick="mx()">MAX</button></div></div>
<div class="cp"><div class="rw"><span>Avg price</span><span id="ap">&mdash;</span></div>
<div class="rw"><span>Slippage</span><span id="slp">&mdash;</span></div>
<div class="rw tt"><span id="cl">Total cost</span><span id="tc">&mdash;</span></div></div>
<button class="bt bb" id="ab" onclick="ex()" disabled>Enter amount</button>
<div class="ts" id="tx"></div></div>
</div>

<div class="ft">powered by smart contracts · <a href="https://chainhost.online">chainhost.online</a></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.1/ethers.umd.min.js"></script>
<script>
// ── Config ──────────────────────────────────────────────────────────
const FACTORY_ADDRESS = "0x72B23955FFeEb864589D94C0661D6BCcEB44e49d";
const FACTORY_ABI = [
    "function createToken(string _tick, uint256 _maxSupply, uint256 _basePrice) returns (address)",
    "function tokenByTick(string) view returns (address)",
    "function allTokens(uint256) view returns (address)",
    "function allTokensLength() view returns (uint256)"
];
const TOKEN_ABI = [
    "function name() view returns (string)",
    "function totalSupply() view returns (uint256)",
    "function maxSupply() view returns (uint256)",
    "function basePrice() view returns (uint256)",
    "function balanceOf(address) view returns (uint256)",
    "function getPrice() view returns (uint256)",
    "function getBuyCost(uint256) view returns (uint256)",
    "function getSellProceeds(uint256) view returns (uint256)",
    "function migrated() view returns (bool)",
    "function buy(uint256 amount) payable",
    "function sell(uint256 amount, uint256 minEth)",
    "function approve(address spender, uint256 value) returns (bool)"
];

var md = "b", provider = null, signer = null;
var factory = null, factoryW = null;
var token = null, tokenW = null, tokenAddr = null;
var userBal = 0n, curSupply = 0n, maxSupply = 0n, basePrice = 0n, isMigrated = false;
var tickName = "", selectedName = "";

// ── JS curve math (for chart) ───────────────────────────────────────
function gp(s, M, B) { return B * Math.pow(s / M, 1.5); }

// ── Fetch ethscription names owned by address ───────────────────────
async function fetchNames(addr) {
    const names = [];
    let pageKey = null;
    do {
        let url = `https://api.ethscriptions.com/v2/ethscriptions?current_owner=${addr}&mimetype=text/plain&per_page=100`;
        if (pageKey) url += `&page_key=${pageKey}`;
        const res = await fetch(url);
        const data = await res.json();
        for (const e of (data.result || [])) {
            const uri = e.content_uri || "";
            if (uri.startsWith("data:,")) {
                const name = decodeURIComponent(uri.slice(6)).trim();
                if (name.length > 0 && name.length <= 32) names.push(name);
            }
        }
        pageKey = data.pagination?.page_key || null;
    } while (pageKey);
    return names;
}

async function renderNames(addr) {
    const loading = document.getElementById("names-loading");
    const list = document.getElementById("name-list");
    const noNames = document.getElementById("no-names");
    loading.textContent = "Loading names for " + addr.slice(0,6) + "...";

    try {
        const names = await fetchNames(addr);
        loading.style.display = "none";

        if (names.length === 0) {
            noNames.style.display = "block";
            return;
        }

        // Check which names already have tokens
        const checks = await Promise.all(names.map(async n => {
            try {
                const existing = await factory.tokenByTick(n);
                return { name: n, used: existing !== "0x0000000000000000000000000000000000000000" };
            } catch {
                return { name: n, used: false };
            }
        }));

        list.innerHTML = "";
        list.style.display = "flex";
        for (const { name, used } of checks) {
            const li = document.createElement("li");
            li.textContent = "$" + name;
            if (used) {
                li.className = "used";
                li.title = "Already launched";
                li.onclick = () => loadToken(name);
            } else {
                li.onclick = () => selectName(name, li);
            }
            list.appendChild(li);
        }
    } catch (e) {
        loading.style.display = "block";
        loading.textContent = "Failed to load names: " + (e.message || e);
        console.error(e);
    }
}

function selectName(name, el) {
    document.querySelectorAll("#name-list li").forEach(li => li.classList.remove("sel"));
    el.classList.add("sel");
    selectedName = name;
    document.getElementById("create-options").style.display = "block";
    document.getElementById("selected-name-btn").textContent = name;
    calcPreview();
}

function calcPreview() {
    const M = parseFloat(document.getElementById("supply-input").value) || 0;
    const B = parseFloat(document.getElementById("price-input").value) || 0;
    if (M <= 0 || B <= 0) return;

    const bpEth = B * 1e-9; // gwei to ETH
    // price(s) = basePrice * (s/M)^1.5
    const migS = M * 0.69;
    const migPrice = bpEth * Math.pow(migS / M, 1.5);
    const fullPrice = bpEth; // at s=M, (M/M)^1.5 = 1

    // integral(s) = basePrice * M * (s/M)^2.5 / 2.5
    const migRaised = bpEth * M * Math.pow(0.69, 2.5) / 2.5;

    // MC = price * totalSupply
    const migMC = migPrice * migS;
    const fdMC = fullPrice * M;

    function fmt(eth) {
        if (eth >= 1) return eth.toFixed(4) + " ETH";
        if (eth >= 0.001) return eth.toFixed(6) + " ETH";
        return eth.toExponential(4) + " ETH";
    }

    document.getElementById("pv-migprice").textContent = fmt(migPrice);
    document.getElementById("pv-migmc").textContent = fmt(migMC);
    document.getElementById("pv-raised").textContent = fmt(migRaised);
    document.getElementById("pv-fullprice").textContent = fmt(fullPrice);
    document.getElementById("pv-fdmc").textContent = fmt(fdMC);
}

// ── Wallet ──────────────────────────────────────────────────────────
async function cw() {
    if (!window.ethereum) { alert("No Ethereum wallet detected."); return; }
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    const addr = await signer.getAddress();
    document.getElementById("cb").style.display = "none";
    document.getElementById("wf").style.display = "block";
    document.getElementById("wa").textContent = addr.slice(0, 6) + "\u2026" + addr.slice(-4);

    factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, provider);
    factoryW = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, signer);

    // Check URL for ?tick= — redirect to subdomain
    const params = new URLSearchParams(window.location.search);
    const tick = params.get("tick");
    if (tick) {
        window.location.href = "https://" + tick.toLowerCase() + ".chainhost.online";
        return;
    } else {
        await renderNames(addr);
    }
}

// ── Create Token ────────────────────────────────────────────────────
async function createToken() {
    const tick = selectedName;
    const supply = document.getElementById("supply-input").value.trim();
    const price = document.getElementById("price-input").value.trim();
    if (!tick || !supply || !price) return;

    const st = document.getElementById("create-status");
    st.className = "ts pe"; st.style.display = "block";
    st.textContent = "Creating $" + tick + "...";

    try {
        // Check if already exists
        const existing = await factory.tokenByTick(tick);
        if (existing !== "0x0000000000000000000000000000000000000000") {
            st.className = "ts er";
            st.textContent = "$" + tick + " already exists!";
            setTimeout(() => loadToken(tick), 1000);
            return;
        }

        const supplyWei = ethers.parseEther(supply);
        const priceWei = BigInt(price) * 1000000000n; // gwei to wei
        const tx = await factoryW.createToken(tick, supplyWei, priceWei);
        st.textContent = "Confirming...";
        await tx.wait();

        st.className = "ts ok";
        st.textContent = "\u2713 $" + tick + " created! Redirecting...";

        // Redirect to subdomain
        setTimeout(() => {
            window.location.href = "https://" + tick + ".chainhost.online";
        }, 1500);
    } catch (e) {
        st.className = "ts er";
        st.textContent = "\u2717 " + (e.reason || e.message || "Failed");
    }
}

// ── Load Token ──────────────────────────────────────────────────────
async function loadToken(tick) {
    tick = tick.toLowerCase();
    tickName = tick;
    tokenAddr = await factory.tokenByTick(tick);
    if (tokenAddr === "0x0000000000000000000000000000000000000000") {
        alert("$" + tick + " not found");
        return;
    }

    token = new ethers.Contract(tokenAddr, TOKEN_ABI, provider);
    tokenW = signer ? new ethers.Contract(tokenAddr, TOKEN_ABI, signer) : null;

    document.getElementById("token-name").textContent = tick;
    document.getElementById("create-panel").style.display = "none";
    document.getElementById("token-panel").style.display = "block";
    if (signer) document.getElementById("token-bal-wrap").style.display = "block";

    await refresh();
}

// ── Refresh contract state ──────────────────────────────────────────
async function refresh() {
    if (!token) return;
    try {
        const [supply, price, ms, bp, bal, migFlag] = await Promise.all([
            token.totalSupply(),
            token.getPrice(),
            token.maxSupply(),
            token.basePrice(),
            signer ? token.balanceOf(await signer.getAddress()) : 0n,
            token.migrated()
        ]);
        curSupply = supply;
        maxSupply = ms;
        basePrice = bp;
        userBal = bal;
        isMigrated = migFlag;

        const supplyNum = Number(ethers.formatEther(supply));
        const maxNum = Number(ethers.formatEther(ms));
        const priceEth = Number(ethers.formatEther(price));
        const reserve = await provider.getBalance(tokenAddr);

        document.getElementById("sp").innerHTML = priceEth.toFixed(10) + ' <span class="pu">ETH</span>';
        document.getElementById("cs").textContent = Math.floor(supplyNum).toLocaleString();
        document.getElementById("ms").textContent = Math.floor(maxNum).toLocaleString();
        document.getElementById("rv").textContent = Number(ethers.formatEther(reserve)).toFixed(6) + " ETH";
        document.getElementById("wb").textContent = Math.floor(Number(ethers.formatEther(bal))).toLocaleString();
        document.getElementById("sb").style.width = (supplyNum / maxNum * 100) + "%";
        document.getElementById("amt-label").textContent = "Amount ($" + tickName + ")";

        if (isMigrated) {
            document.getElementById("migrated-msg").style.display = "block";
            document.getElementById("trade-card").style.display = "none";
            document.getElementById("uni-link").href =
                "https://app.uniswap.org/#/swap?outputCurrency=" + tokenAddr;
        }
        dc(supplyNum, maxNum, Number(ethers.formatEther(bp)));
    } catch (e) {
        console.error("refresh error", e);
    }
}

// ── Mode switch ─────────────────────────────────────────────────────
function sm(m) {
    md = m;
    document.getElementById("tb").className = m === "b" ? "tab a" : "tab";
    document.getElementById("ts2").className = m === "s" ? "tab a" : "tab";
    document.getElementById("ab").className = m === "b" ? "bt bb" : "bt bs";
    document.getElementById("cl").textContent = m === "b" ? "Total cost" : "You receive";
    up();
}

function mx() {
    if (md === "s") {
        document.getElementById("am").value = Math.floor(Number(ethers.formatEther(userBal)));
    } else {
        const maxNum = Number(ethers.formatEther(maxSupply));
        const curNum = Number(ethers.formatEther(curSupply));
        const remaining = maxNum * 0.69 - curNum;
        document.getElementById("am").value = Math.floor(Math.max(0, remaining));
    }
    up();
}

// ── Preview ─────────────────────────────────────────────────────────
async function up() {
    const a = parseFloat(document.getElementById("am").value) || 0;
    const b = document.getElementById("ab");
    if (a <= 0 || !token) {
        document.getElementById("ap").textContent = "\u2014";
        document.getElementById("slp").textContent = "\u2014";
        document.getElementById("tc").textContent = "\u2014";
        b.disabled = true;
        b.textContent = "Enter amount";
        return;
    }
    try {
        const amountWei = ethers.parseEther(String(a));
        if (md === "b") {
            const cost = await token.getBuyCost(amountWei);
            const costEth = Number(ethers.formatEther(cost));
            const avg = costEth / a;
            document.getElementById("ap").textContent = avg.toFixed(10) + " ETH";
            document.getElementById("slp").textContent = "~1%";
            document.getElementById("tc").textContent = costEth.toFixed(8) + " ETH";
            b.disabled = !signer;
            b.textContent = signer ? "Buy " + a.toLocaleString() + " $" + tickName : "Connect wallet";
        } else {
            const proceeds = await token.getSellProceeds(amountWei);
            const procEth = Number(ethers.formatEther(proceeds));
            const avg = procEth / a;
            document.getElementById("ap").textContent = avg.toFixed(10) + " ETH";
            document.getElementById("slp").textContent = "~1%";
            document.getElementById("tc").textContent = procEth.toFixed(8) + " ETH";
            b.disabled = !signer;
            b.textContent = signer ? "Sell " + a.toLocaleString() + " $" + tickName : "Connect wallet";
        }
    } catch (e) {
        b.disabled = true;
        b.textContent = "Invalid amount";
    }
}

// ── Execute buy/sell ────────────────────────────────────────────────
async function ex() {
    const a = parseFloat(document.getElementById("am").value);
    if (!a || !tokenW) return;
    const st = document.getElementById("tx");
    st.className = "ts pe"; st.style.display = "block";
    st.textContent = "Waiting for wallet...";
    try {
        const amountWei = ethers.parseEther(String(a));
        let tx;
        if (md === "b") {
            const cost = await token.getBuyCost(amountWei);
            const costWithSlippage = cost * 101n / 100n;
            tx = await tokenW.buy(amountWei, { value: costWithSlippage });
        } else {
            const proceeds = await token.getSellProceeds(amountWei);
            const minEth = proceeds * 99n / 100n;
            const approveTx = await tokenW.approve(tokenAddr, amountWei);
            await approveTx.wait();
            tx = await tokenW.sell(amountWei, minEth);
        }
        st.className = "ts pe"; st.textContent = "Confirming...";
        await tx.wait();
        st.className = "ts ok";
        st.innerHTML = "\u2713 Done! <a href=\"https://etherscan.io/tx/" + tx.hash +
            "\" target=\"_blank\" style=\"color:var(--green)\">" + tx.hash.slice(0, 18) + "\u2026</a>";
        document.getElementById("am").value = "";
        await refresh();
        up();
    } catch (e) {
        st.className = "ts er";
        st.textContent = "\u2717 " + (e.reason || e.message || "Rejected");
    }
}

// ── Draw curve chart ────────────────────────────────────────────────
function dc(supplyNum, maxNum, bp) {
    supplyNum = supplyNum || 0; maxNum = maxNum || 1; bp = bp || 1;
    const cv = document.getElementById("cc"), cx = cv.getContext("2d");
    const d = window.devicePixelRatio || 1, W = cv.clientWidth, H = cv.clientHeight;
    cv.width = W * d; cv.height = H * d; cx.scale(d, d);
    cx.clearRect(0, 0, W, H);
    cx.strokeStyle = "#1e1e2e"; cx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) { const y = H / 4 * i; cx.beginPath(); cx.moveTo(0, y); cx.lineTo(W, y); cx.stroke(); }
    cx.beginPath(); cx.strokeStyle = "#c3ff00"; cx.lineWidth = 2;
    const maxP = gp(maxNum, maxNum, bp);
    for (let i = 0; i <= 200; i++) {
        const s = maxNum / 200 * i, p = gp(s, maxNum, bp);
        const x = i / 200 * W, y = H - (p / maxP) * (H - 10) - 5;
        i === 0 ? cx.moveTo(x, y) : cx.lineTo(x, y);
    }
    cx.stroke();
    const sp = supplyNum / maxNum;
    cx.beginPath(); cx.fillStyle = "#c3ff0022";
    for (let i = 0; i <= Math.floor(sp * 200); i++) {
        const s = maxNum / 200 * i, p = gp(s, maxNum, bp);
        const x = i / 200 * W, y = H - (p / maxP) * (H - 10) - 5;
        i === 0 ? (cx.moveTo(x, H), cx.lineTo(x, y)) : cx.lineTo(x, y);
    }
    cx.lineTo(sp * W, H); cx.closePath(); cx.fill();
    if (supplyNum > 0) {
        const cx2 = sp * W, cy = H - (gp(supplyNum, maxNum, bp) / maxP) * (H - 10) - 5;
        cx.beginPath(); cx.arc(cx2, cy, 5, 0, Math.PI * 2); cx.fillStyle = "#c3ff00"; cx.fill();
        cx.strokeStyle = "#fff"; cx.lineWidth = 2; cx.stroke();
    }
}

// ── Init ────────────────────────────────────────────────────────────
// tick from URL is handled after wallet connect
</script>
</body>
</html>
